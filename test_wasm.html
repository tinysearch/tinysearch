<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TinySearch WASM Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        #results { margin-top: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .error { color: red; }
        .success { color: green; }
        input { padding: 8px; margin: 4px; }
        button { padding: 8px 16px; }
    </style>
</head>
<body>
    <h1>üîç TinySearch WASM Test</h1>
    <div id="status">Loading...</div>
    <input type="text" id="search-input" placeholder="Enter search query (try 'rust')" value="rust" />
    <button onclick="performSearch()">Search</button>
    <div id="results"></div>

    <script>
        let searchEngine = null;
        
        async function initializeSearch() {
            try {
                console.log('Loading WASM from: ./wasm_test_output/tinysearch_engine.wasm');
                
                // Load the WASM file from the correct path
                const response = await fetch('./wasm_test_output/tinysearch_engine.wasm');
                if (!response.ok) {
                    throw new Error(`Failed to fetch WASM: ${response.status} ${response.statusText}`);
                }
                
                const wasmBytes = await response.arrayBuffer();
                console.log(`Loaded ${wasmBytes.byteLength} bytes of WASM`);
                
                const wasmModule = await WebAssembly.instantiate(wasmBytes);
                console.log('WASM compiled successfully');
                
                // Create the search engine wrapper
                searchEngine = {
                    wasm: wasmModule.instance,
                    memory: wasmModule.instance.exports.memory,
                    searchFn: wasmModule.instance.exports.search,
                    freeFn: wasmModule.instance.exports.free_search_result,
                    
                    stringToWasm(str) {
                        const bytes = new TextEncoder().encode(str + '\0');
                        const ptr = this.allocString(bytes.length);
                        const mem = new Uint8Array(this.memory.buffer, ptr, bytes.length);
                        mem.set(bytes);
                        return ptr;
                    },
                    
                    wasmToString(ptr) {
                        if (ptr === 0) return null;
                        const mem = new Uint8Array(this.memory.buffer);
                        let end = ptr;
                        while (mem[end] !== 0) end++;
                        return new TextDecoder().decode(mem.subarray(ptr, end));
                    },
                    
                    allocString(len) {
                        const pages = Math.ceil(len / 65536);
                        this.memory.grow(pages);
                        return this.memory.buffer.byteLength - len;
                    },
                    
                    search(query, numResults = 5) {
                        const queryPtr = this.stringToWasm(query);
                        const resultPtr = this.searchFn(queryPtr, numResults);
                        
                        if (resultPtr === 0) {
                            return [];
                        }
                        
                        const jsonStr = this.wasmToString(resultPtr);
                        this.freeFn(resultPtr);
                        
                        try {
                            return JSON.parse(jsonStr);
                        } catch (e) {
                            console.error('Failed to parse search results:', e);
                            return [];
                        }
                    }
                };
                
                console.log('TinySearch initialized successfully');
                document.getElementById('status').innerHTML = '<span class="success">‚úÖ Search engine initialized!</span>';
                
                // Auto-search on load
                performSearch();
                
            } catch (error) {
                console.error('Failed to initialize search:', error);
                document.getElementById('status').innerHTML = '<span class="error">‚ùå Failed to initialize: ' + error.message + '</span>';
            }
        }
        
        function performSearch() {
            if (!searchEngine) {
                document.getElementById('results').innerHTML = '<p class="error">Search engine not initialized</p>';
                return;
            }
            
            const query = document.getElementById('search-input').value;
            if (!query.trim()) {
                document.getElementById('results').innerHTML = '<p>Please enter a search query</p>';
                return;
            }
            
            try {
                const startTime = performance.now();
                const results = searchEngine.search(query, 5);
                const endTime = performance.now();
                const searchTime = (endTime - startTime).toFixed(2);
                
                console.log('Search results:', results);
                
                let html = `<h3>üéØ Results for "${query}" (${searchTime}ms):</h3>`;
                
                if (results.length === 0) {
                    html += '<p>No results found. Try searching for "rust", "javascript", or "blog".</p>';
                } else {
                    results.forEach((result, i) => {
                        html += `<div class="result">`;
                        html += `<strong>${i + 1}. ${result.title}</strong><br>`;
                        html += `<a href="${result.url}" target="_blank">${result.url}</a>`;
                        if (result.meta) html += `<br><em>Meta: ${result.meta}</em>`;
                        html += `</div>`;
                    });
                }
                
                document.getElementById('results').innerHTML = html;
            } catch (error) {
                console.error('Search failed:', error);
                document.getElementById('results').innerHTML = '<p class="error">‚ùå Search failed: ' + error.message + '</p>';
            }
        }
        
        // Add Enter key support
        document.getElementById('search-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                performSearch();
            }
        });
        
        // Initialize on page load
        initializeSearch();
    </script>
</body>
</html>